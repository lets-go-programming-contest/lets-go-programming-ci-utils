version: "3"

env:
  STUDENT_REGEXP_PATTERN: "[a-z0-9]+.[a-z0-9]+"
  TASK_REGEXP_PATTERN: "task-[0-9-]+"
  LAB_FILES_REGEXP_PATTERN: '{{ printf "^%s/%s/.+$" .STUDENT_REGEXP_PATTERN .TASK_REGEXP_PATTERN }}'

_common_vars: 
  TARGET: &TARGET_VAR
    sh: '{{ .TASKFILE_DIR }}/../scripts/validate_rev.bash {{.TARGET | default "origin/main" }}'    
  HEAD: &HEAD_VAR
    sh: '{{ .TASKFILE_DIR }}/../scripts/validate_rev.bash {{.HEAD | default "HEAD" }}'
  DIFF: &DIFF_VAR
    sh: 'TARGET="{{ .TARGET }}" HEAD="{{ .HEAD }}" {{ .TASKFILE_DIR }}/../scripts/get_affected_files.bash'
  LAB_FILES: &LAB_FILES_VAR 
    sh: 'DIFF="{{ .DIFF }}" {{ .TASKFILE_DIR }}/../scripts/get_lab_files.bash'
  STUDENTS: &STUDENTS_VAR
    sh: 'LAB_FILES="{{ .LAB_FILES }}" {{ .TASKFILE_DIR }}/../scripts/get_students.bash'
  TASKS: &TASKS_VAR
    sh: 'TASKS="{{ .TASKS }}" {{ .TASKFILE_DIR }}/../scripts/get_tasks.bash'

tasks:
  files:
    vars:
      TARGET: *TARGET_VAR
      HEAD: *HEAD_VAR
      DIFF: *DIFF_VAR
      LAB_FILES: *LAB_FILES_VAR
      NO_LAB_FILES:
        sh: >- 
          {{ $diff := (splitList "\n" .DIFF) }}
          {{ $labFiles := (splitList "\n" .LAB_FILES) }}
          {{ $noLabFiles := (list) }}
          {{ range $i, $file := $diff }}
            {{ if not ($labFiles | has $file) }}
              {{ $noLabFiles = append $noLabFiles $file }}
            {{ end }}
          {{ end }}
          echo "{{ $noLabFiles | join "\n" }}"
    cmds:
      - cmd: |
          TARGET="{{.TARGET}}" \
          HEAD="{{.HEAD}}" \
          MAINTAINERS_FILE="{{.COMMON_DIR}}/MAINTAINERS" \
          FILES_FOR_CHECK="{{.NO_LAB_FILES}}" \
          {{ .TASKFILE_DIR }}/../scripts/check_files_authors.bash
        silent: true
      - cmd: |
          echo "Affected files list:"
          {{ range $i, $file := (.DIFF | splitList "\n")  }}
            echo "- {{ $file }}"
          {{ end}}
        silent: true

  tasks:
    vars:
      TARGET: *TARGET_VAR
      HEAD: *HEAD_VAR
      DIFF: *DIFF_VAR
      LAB_FILES: *LAB_FILES_VAR
      TASKS: *TASKS_VAR
    cmds:
      - cmd: |
          {{if not .TASKS }}
          echo "Changes for at least one task must be submitted in commits!" >&2
          exit 1
          {{end}}
        silent: true
      - cmd: |
          {{ $tasks := (splitList "\n" .TASKS) }}
          {{if gt (len $tasks) 1}}
            echo "The next tasks has been presented for review:" >&2
            {{range $i, $task := $tasks}}
              echo "- {{ $task }}" 
            {{end}}
            echo "However, commits should only contain changes for one task!" >&2
            exit 1
          {{else}}
            echo "Task {{ index $tasks 0 }} are accepted for automatic review!"
          {{end}}
        silent: true


  students:
    vars:
      TARGET: *TARGET_VAR
      HEAD: *HEAD_VAR
      DIFF: *DIFF_VAR
      LAB_FILES: *LAB_FILES_VAR
      STUDENTS: *STUDENTS_VAR
    cmds:
      - cmd: |
          {{ if not .STUDENTS }}
          echo "Changes for at least one student must be submitted in commits!" >&2
          exit 1
          {{end}}
        silent: true
      - cmd: |
          {{ $students := (splitList "\n" .STUDENTS) }}
          {{if gt (len $students) 1}}
            echo "The work of the following students has been presented for review:" >&2
            {{range $i, $student := $students}}
              echo "- {{ $student }}" 
            {{end}}
            echo "However, commits should only contain changes for one student!" >&2
            exit 1
          {{else}}
            echo "Tasks by {{ index $students 0 }} are accepted for automatic review!"
          {{end}}
        silent: true

  get:students:
    vars:
      TARGET: *TARGET_VAR
      HEAD: *HEAD_VAR
      DIFF: *DIFF_VAR
      LAB_FILES: *LAB_FILES_VAR
      STUDENTS: *STUDENTS_VAR
      FORMAT: '{{ .FORMAT | default "%s\n" }}'
    cmds:
      - cmd: |
          {{ if not .STUDENTS }}
            echo "Students not found." >&2
            exit 1
          {{end}}
        silent: true
      - cmd: printf "{{ .FORMAT }}" "{{ .STUDENTS }}"
        silent: true

  get:tasks:
    vars:
      TARGET: *TARGET_VAR
      HEAD: *HEAD_VAR
      DIFF: *DIFF_VAR
      LAB_FILES: *LAB_FILES_VAR
      TASKS: *TASKS_VAR
      FORMAT: '{{ .FORMAT | default "%s\n" }}'
    cmds:
      - cmd: |
          {{ if not .TASKS }}
            echo "Tasks not found." >&2
            exit 1
          {{end}}
        silent: true
      - cmd: printf "{{ .FORMAT }}" "{{ .TASKS }}"
        silent: true
